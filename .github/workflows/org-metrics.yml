name: Organization Metrics

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate organization stats
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“Š Fetching TheFactoryX stats..."

          # Get org info
          org_data=$(gh api orgs/TheFactoryX)
          followers=$(echo "$org_data" | jq '.followers // 0')
          public_repos=$(echo "$org_data" | jq '.public_repos // 0')

          # Get total stars across all repos
          total_stars=$(gh api orgs/TheFactoryX/repos --paginate --jq '[.[].stargazers_count] | add // 0')

          # Get total forks
          total_forks=$(gh api orgs/TheFactoryX/repos --paginate --jq '[.[].forks_count] | add // 0')

          # Get languages
          languages=$(gh api orgs/TheFactoryX/repos --paginate --jq '[.[].language // empty] | group_by(.) | map({(.[0]): length}) | add')

          echo "Followers: $followers"
          echo "Repos: $public_repos"
          echo "Stars: $total_stars"
          echo "Forks: $total_forks"

          # Generate stats markdown
          cat > profile/STATS.md << EOF
          ## ðŸ“Š Factory Statistics

          | Metric | Count |
          |--------|-------|
          | ðŸ‘¥ Followers | $followers |
          | ðŸ“¦ Repositories | $public_repos |
          | â­ Total Stars | $total_stars |
          | ðŸ´ Total Forks | $total_forks |

          *Last updated: $(date -u '+%Y-%m-%d %H:%M UTC')*
          EOF

          # Save raw stats as JSON
          cat > profile/stats.json << EOF
          {
            "followers": $followers,
            "repos": $public_repos,
            "stars": $total_stars,
            "forks": $total_forks,
            "updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Commit stats
        run: |
          git config --local user.email "factory@thefactoryx.art"
          git config --local user.name "The Factory"
          git add profile/STATS.md profile/stats.json
          git diff --staged --quiet || git commit -m "ðŸ“Š Update org stats"
          git push
