name: Organization Metrics

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Generate organization metrics
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          user: TheFactoryX
          template: classic
          base: header, activity, community, repositories
          config_timezone: UTC

          # Organization specific
          plugin_followup: yes
          plugin_followup_sections: repositories

          # Repositories
          plugin_repositories: yes
          plugin_repositories_order: featured, pinned, starred, random

          # Activity
          plugin_activity: yes
          plugin_activity_limit: 5
          plugin_activity_days: 14

          # Habits (commit heatmap)
          plugin_habits: yes
          plugin_habits_charts: yes
          plugin_habits_days: 14

          # Languages
          plugin_languages: yes
          plugin_languages_sections: most-used
          plugin_languages_limit: 8

          # Stars
          plugin_stargazers: yes
          plugin_stargazers_charts: yes

          # Output
          filename: profile/metrics.svg
          output_action: commit

      - name: Generate followers count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get org followers count
          followers=$(gh api orgs/TheFactoryX --jq '.followers // 0')
          echo "Organization followers: $followers"

          # Get total stars across all repos
          total_stars=$(gh api orgs/TheFactoryX/repos --paginate --jq '[.[].stargazers_count] | add')
          echo "Total stars: $total_stars"

          # Get total repos
          total_repos=$(gh api orgs/TheFactoryX/repos --paginate --jq 'length')
          echo "Total repos: $total_repos"

          # Save stats to file
          echo "{\"followers\": $followers, \"stars\": $total_stars, \"repos\": $total_repos, \"updated\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > profile/stats.json

      - name: Commit stats
        run: |
          git config --local user.email "factory@thefactoryx.art"
          git config --local user.name "The Factory"
          git add profile/stats.json
          git diff --staged --quiet || git commit -m "ðŸ“Š Update org stats"
          git push
